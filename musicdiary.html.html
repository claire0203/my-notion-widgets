<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Music Diary</title>
    <style>
        body { font-family: 'Pretendard', sans-serif; max-width: 600px; margin: 0 auto; padding: 20px; background-color: #f4f4f4; }
        h1 { text-align: center; color: #333; }
        
        /* ì…ë ¥ í¼ ìŠ¤íƒ€ì¼ */
        .input-group { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); margin-bottom: 20px; }
        input { width: 100%; padding: 10px; margin-bottom: 10px; border: 1px solid #ddd; border-radius: 5px; box-sizing: border-box; }
        button#save-btn { width: 100%; padding: 10px; background-color: #333; color: white; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; }
        button#save-btn:hover { background-color: #555; }
        button#cancel-btn { width: 100%; padding: 10px; background-color: #999; color: white; border: none; border-radius: 5px; cursor: pointer; margin-top: 5px; display: none; }

        /* ë¦¬ìŠ¤íŠ¸ ìŠ¤íƒ€ì¼ */
        .music-item { background: white; padding: 15px; border-radius: 10px; margin-bottom: 15px; display: flex; align-items: center; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .cover-img { width: 80px; height: 80px; object-fit: cover; border-radius: 5px; margin-right: 15px; background-color: #eee; }
        .info { flex-grow: 1; }
        .date { font-size: 12px; color: #888; margin-bottom: 4px; }
        .title { font-size: 18px; font-weight: bold; margin: 0; color: #222; text-decoration: none; }
        .artist { font-size: 14px; color: #555; margin-top: 4px; }
        
        /* ë²„íŠ¼ ê·¸ë£¹ */
        .btn-group { display: flex; flex-direction: column; gap: 5px; }
        .edit-btn { background-color: #4CAF50; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 12px; }
        .delete-btn { background-color: #ff4d4d; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 12px; }
    </style>
</head>
<body>

    <h1>ğŸ§ My Music Diary</h1>

    <div class="input-group">
        <input type="date" id="date">
        <input type="text" id="title" placeholder="ë…¸ë˜ ì œëª© (ì˜ˆ: JoyRide)">
        <input type="text" id="artist" placeholder="ê°€ìˆ˜ (ì˜ˆ: CORTIS)">
        <input type="text" id="url" placeholder="ìœ íŠœë¸Œ ë§í¬">
        <button id="save-btn" onclick="saveMusic()">ê¸°ë¡í•˜ê¸°</button>
        <button id="cancel-btn" onclick="resetForm()">ì·¨ì†Œ</button>
    </div>

    <div id="music-list">
        <p style="text-align: center; color: #888;">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</p>
    </div>

    <script>
        // ğŸ”’ ì„¤ì •: ë³¸ì¸ì˜ JSONBin ì •ë³´ë¥¼ ì—¬ê¸°ì— ì…ë ¥í•˜ì„¸ìš”
        const API_KEY = '$2a$10$7/urvzV65WS3eRC9dhD4Pe5dDs/W2TYnytNLMFjLA3Tst3JXORJwO'; // Master Key
        const BIN_ID = '693ed52743b1c97be9edc4dd'; // Bin ID
        
        let musicData = []; // ë°ì´í„°ë¥¼ ë‹´ì„ ì „ì—­ ë³€ìˆ˜
        let isEditing = false; // í˜„ì¬ ìˆ˜ì • ëª¨ë“œì¸ì§€ í™•ì¸
        let editIndex = null; // ìˆ˜ì • ì¤‘ì¸ ì•„ì´í…œì˜ ì¸ë±ìŠ¤

        // 1. ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸° (Read)
        async function loadMusic() {
            try {
                const response = await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}/latest`, {
                    headers: { 'X-Master-Key': API_KEY }
                });
                const data = await response.json();
                musicData = data.record; // ë°ì´í„° ì €ì¥
                renderList(); // í™”ë©´ ê·¸ë¦¬ê¸°
            } catch (error) {
                console.error("ë¡œë”© ì‹¤íŒ¨:", error);
                document.getElementById('music-list').innerHTML = "ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì§€ ëª»í–ˆìŠµë‹ˆë‹¤.";
            }
        }

        // 2. í™”ë©´ì— ë¦¬ìŠ¤íŠ¸ ê·¸ë¦¬ê¸°
        function renderList() {
            const listContainer = document.getElementById('music-list');
            listContainer.innerHTML = '';

            // ìµœì‹  ë‚ ì§œê°€ ìœ„ë¡œ ì˜¤ê²Œ ì •ë ¬ (ì„ íƒì‚¬í•­)
            // musicData.sort((a, b) => new Date(b.date) - new Date(a.date));

            musicData.forEach((item, index) => {
                const div = document.createElement('div');
                div.className = 'music-item';
                div.innerHTML = `
                    <img src="${item.cover}" class="cover-img" onerror="this.src='https://via.placeholder.com/80?text=No+Img'">
                    <div class="info">
                        <div class="date">${item.date}</div>
                        <a href="${item.url}" target="_blank" class="title">${item.title}</a>
                        <div class="artist">${item.artist}</div>
                    </div>
                    <div class="btn-group">
                        <button class="edit-btn" onclick="startEdit(${index})">ìˆ˜ì •</button>
                        <button class="delete-btn" onclick="deleteMusic(${index})">ì‚­ì œ</button>
                    </div>
                `;
                listContainer.appendChild(div);
            });
        }

        // 3. ìˆ˜ì • ëª¨ë“œ ì‹œì‘ (Edit Mode)
        function startEdit(index) {
            const item = musicData[index];
            
            // ì…ë ¥ì°½ì— ê°’ ì±„ì›Œë„£ê¸°
            document.getElementById('date').value = item.date;
            document.getElementById('title').value = item.title;
            document.getElementById('artist').value = item.artist;
            document.getElementById('url').value = item.url;

            // ìƒíƒœ ë³€ê²½
            isEditing = true;
            editIndex = index;

            // ë²„íŠ¼ ëª¨ì–‘ ë³€ê²½
            const saveBtn = document.getElementById('save-btn');
            saveBtn.textContent = "ìˆ˜ì • ì™„ë£Œ";
            saveBtn.style.backgroundColor = "#4CAF50"; // ì´ˆë¡ìƒ‰ìœ¼ë¡œ ë³€ê²½
            document.getElementById('cancel-btn').style.display = "block"; // ì·¨ì†Œ ë²„íŠ¼ ë³´ì´ê¸°

            // ìŠ¤í¬ë¡¤ì„ ë§¨ ìœ„ë¡œ (ì…ë ¥ì°½ìœ¼ë¡œ)
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // 4. ì €ì¥ ë° ìˆ˜ì • ì‹¤í–‰ (Create & Update)
        async function saveMusic() {
            const date = document.getElementById('date').value;
            const title = document.getElementById('title').value;
            const artist = document.getElementById('artist').value;
            const url = document.getElementById('url').value;

            if (!title || !url) {
                alert("ì œëª©ê³¼ ë§í¬ëŠ” í•„ìˆ˜ì…ë‹ˆë‹¤!");
                return;
            }

            // ìœ íŠœë¸Œ ì¸ë„¤ì¼ ìë™ ì¶”ì¶œ
            let videoId = url.split('v=')[1];
            if (videoId) {
                const ampersandPosition = videoId.indexOf('&');
                if (ampersandPosition !== -1) {
                    videoId = videoId.substring(0, ampersandPosition);
                }
            }
            const cover = videoId ? `https://img.youtube.com/vi/${videoId}/0.jpg` : 'https://via.placeholder.com/80';

            const newItem = { date, title, artist, url, cover };

            if (isEditing) {
                // ìˆ˜ì • ëª¨ë“œì¼ ê²½ìš°: í•´ë‹¹ ì¸ë±ìŠ¤ì˜ ë°ì´í„° êµì²´
                musicData[editIndex] = newItem;
                alert("ìˆ˜ì •ë˜ì—ˆìŠµë‹ˆë‹¤! (ì„œë²„ ì €ì¥ ì¤‘...)");
            } else {
                // ì¼ë°˜ ëª¨ë“œì¼ ê²½ìš°: ìƒˆ ë°ì´í„° ì¶”ê°€
                musicData.push(newItem);
                alert("ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤! (ì„œë²„ ì €ì¥ ì¤‘...)");
            }

            // ì„œë²„ì— ì €ì¥ (PUT)
            await updateBin();
            resetForm(); // í¼ ì´ˆê¸°í™”
        }

        // 5. ì‚­ì œ ê¸°ëŠ¥ (Delete)
        async function deleteMusic(index) {
            if(confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                musicData.splice(index, 1); // ë°°ì—´ì—ì„œ ì‚­ì œ
                await updateBin(); // ì„œë²„ ì €ì¥
            }
        }

        // 6. JSONBin ì—…ë°ì´íŠ¸ (ê³µí†µ í•¨ìˆ˜)
        async function updateBin() {
            try {
                await fetch(`https://api.jsonbin.io/v3/b/${BIN_ID}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Master-Key': API_KEY
                    },
                    body: JSON.stringify(musicData)
                });
                renderList(); // í™”ë©´ ê°±ì‹ 
            } catch (error) {
                console.error("ì €ì¥ ì‹¤íŒ¨:", error);
                alert("ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.");
            }
        }

        // 7. í¼ ì´ˆê¸°í™”
        function resetForm() {
            document.getElementById('date').value = '';
            document.getElementById('title').value = '';
            document.getElementById('artist').value = '';
            document.getElementById('url').value = '';
            
            isEditing = false;
            editIndex = null;
            
            const saveBtn = document.getElementById('save-btn');
            saveBtn.textContent = "ê¸°ë¡í•˜ê¸°";
            saveBtn.style.backgroundColor = "#333";
            document.getElementById('cancel-btn').style.display = "none";
        }

        // ì‹œì‘ ì‹œ ë°ì´í„° ë¡œë“œ
        document.getElementById('date').valueAsDate = new Date(); // ì˜¤ëŠ˜ ë‚ ì§œ ê¸°ë³¸ ì„¤ì •
        loadMusic();
    </script>
</body>
</html>