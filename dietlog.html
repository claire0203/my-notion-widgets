<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Kitsch Diet Planner</title>
<style>
  /* --- Theme: Kitsch & Pastel Blue --- */
  :root {
    --bg-color: transparent;
    --main-color: #D7E8F7;
    --accent-color: #90CAF9;
    --accent-dark: #64B5F6;
    --text-color: #546E7A;
    --paper-bg: #ffffff;
    --shadow: 0 4px 15px rgba(144, 202, 249, 0.2);
    --font-stack: -apple-system, BlinkMacSystemFont, "Pretendard", sans-serif;
  }

  body {
    background-color: var(--bg-color);
    margin: 0; padding: 10px;
    font-family: var(--font-stack);
    display: flex; justify-content: center;
    box-sizing: border-box;
    color: var(--text-color);
  }

  /* ë©”ì¸ ì»¨í…Œì´ë„ˆ */
  .diet-card {
    width: 100%; max-width: 400px;
    background: var(--main-color);
    border-radius: 20px;
    padding: 20px;
    box-shadow: var(--shadow);
    border: 4px solid #fff;
    outline: 2px dashed #BBDEFB;
    min-height: 500px;
    position: relative;
  }

  /* í—¤ë” & ë‚ ì§œ ë„¤ë¹„ê²Œì´ì…˜ */
  header {
    text-align: center; margin-bottom: 20px;
  }
  h1 {
    font-size: 20px; color: #fff; text-transform: uppercase;
    text-shadow: 1px 1px 0 rgba(0,0,0,0.1); margin: 0 0 10px 0;
  }
  
  .week-nav {
    display: flex; justify-content: space-between; align-items: center;
    background: rgba(255,255,255,0.5); padding: 8px; border-radius: 12px;
  }
  .nav-btn {
    background: #fff; border: none; border-radius: 50%; width: 28px; height: 28px;
    cursor: pointer; color: var(--accent-dark); font-weight: bold;
    transition: 0.2s;
  }
  .nav-btn:hover { background: var(--accent-color); color: #fff; }
  .current-week { font-size: 13px; font-weight: 700; color: #455A64; }

  /* ìš”ì¼ ë¦¬ìŠ¤íŠ¸ (ì•„ì½”ë””ì–¸) */
  .day-list {
    display: flex; flex-direction: column; gap: 10px;
    max-height: 600px; overflow-y: auto;
    padding-right: 5px;
  }
  /* ìŠ¤í¬ë¡¤ë°” ìˆ¨ê¹€ */
  .day-list::-webkit-scrollbar { width: 4px; }
  .day-list::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.5); border-radius: 4px; }

  .day-item {
    background: var(--paper-bg);
    border-radius: 12px;
    box-shadow: 0 2px 5px rgba(0,0,0,0.05);
    overflow: hidden;
    transition: all 0.3s ease;
    border: 1px solid #E1F5FE;
  }

  /* ë‚ ì§œ í—¤ë” (í´ë¦­ ì‹œ í¼ì¹¨) */
  .day-header {
    padding: 12px 15px;
    display: flex; justify-content: space-between; align-items: center;
    cursor: pointer; background: #fff;
  }
  .day-header:hover { background: #F1F8FF; }
  .day-title { font-weight: 700; font-size: 14px; display: flex; align-items: center; gap: 6px; }
  .day-summary { font-size: 11px; color: #B0BEC5; }
  
  /* ì˜¤ëŠ˜ ë‚ ì§œ ê°•ì¡° */
  .day-item.today { border: 2px solid var(--accent-color); }
  .day-item.today .day-title::before { content: 'TODAY'; font-size: 9px; background: #FFCC80; color: #E65100; padding: 2px 4px; border-radius: 4px; margin-right: 5px; }

  /* í¼ì³ì§€ëŠ” ë‚´ìš© */
  .day-content {
    display: none; padding: 15px; border-top: 1px dashed #E0E0E0; background: #FAFAFA;
  }
  .day-item.active .day-content { display: block; }
  .day-item.active .day-header { background: #E3F2FD; }

  /* ìŠµê´€ ì²´í¬ ì„¹ì…˜ */
  .habit-section {
    display: flex; gap: 10px; justify-content: center; margin-bottom: 15px;
    background: #fff; padding: 10px; border-radius: 10px; border: 1px solid #ECEFF1;
  }
  .habit-check {
    display: flex; align-items: center; gap: 5px; font-size: 13px; font-weight: 600; cursor: pointer;
    user-select: none; position: relative;
  }
  .habit-check input { display: none; } /* ê¸°ë³¸ ì²´í¬ë°•ìŠ¤ ìˆ¨ê¹€ */
  .habit-icon {
    width: 20px; height: 20px; border: 2px solid #CFD8DC; border-radius: 50%;
    display: flex; align-items: center; justify-content: center; color: transparent;
    transition: 0.2s;
  }
  /* ì²´í¬ë˜ì—ˆì„ ë•Œ ìŠ¤íƒ€ì¼ */
  .habit-check input:checked + .habit-icon {
    background: var(--accent-color); border-color: var(--accent-color); color: #fff;
  }
  
  /* ì‹ë‹¨ ì…ë ¥ ì„¹ì…˜ */
  .meal-row { margin-bottom: 10px; display: flex; flex-direction: column; gap: 4px; }
  .meal-label { font-size: 12px; font-weight: 700; color: #78909C; display: flex; justify-content: space-between; }
  
  .skip-label { font-size: 11px; cursor: pointer; display: flex; align-items: center; gap: 3px; color: #90A4AE; }
  .skip-label input { margin: 0; }

  .meal-input {
    width: 100%; padding: 10px; border: 1px solid #CFD8DC; border-radius: 8px;
    font-family: var(--font-stack); font-size: 13px; box-sizing: border-box; outline: none;
    background: #fff; transition: 0.2s;
  }
  .meal-input:focus { border-color: var(--accent-color); }
  
  /* SKIP ìƒíƒœì¼ ë•Œ */
  .meal-input.skipped {
    background: #ECEFF1; color: #B0BEC5; text-decoration: line-through; pointer-events: none;
  }

  /* ì €ì¥ ë²„íŠ¼ */
  .save-btn {
    width: 100%; padding: 12px; background: var(--accent-color); color: white;
    border: none; border-radius: 10px; font-weight: 800; cursor: pointer; margin-top: 10px;
    transition: 0.2s;
  }
  .save-btn:hover { background: var(--accent-dark); }

  /* ë¡œë”© í‘œì‹œ */
  #loading { font-size: 11px; text-align: center; color: #fff; margin-bottom: 5px; height: 15px;}

  /* ğŸ‰ ì• ë‹ˆë©”ì´ì…˜ íš¨ê³¼ (Confetti) */
  .confetti {
    position: absolute; width: 8px; height: 8px; background: #FFD54F;
    animation: pop 0.6s ease-out forwards; pointer-events: none;
  }
  @keyframes pop {
    0% { transform: translate(0, 0) scale(1); opacity: 1; }
    100% { transform: translate(var(--tx), var(--ty)) scale(0); opacity: 0; }
  }

</style>
</head>
<body>

<div class="diet-card">
  <header>
    <h1>ğŸ¥— Weekly Diet</h1>
    <div id="loading">Loading...</div>
    <div class="week-nav">
      <button class="nav-btn" onclick="changeWeek(-7)">â€¹</button>
      <span class="current-week" id="weekRange">...</span>
      <button class="nav-btn" onclick="changeWeek(7)">â€º</button>
    </div>
  </header>

  <div class="day-list" id="dayList">
    </div>
</div>

<script>
  // ===========================================
  // ğŸ”’ ì„¤ì •: ì‹ë‹¨ìš© Bin IDë¥¼ ì…ë ¥í•˜ì„¸ìš”!
  const DIET_BIN_ID = "6941866443b1c97be9f29930"; 
  const API_KEY = "$2a$10$7/urvzV65WS3eRC9dhD4Pe5dDs/W2TYnytNLMFjLA3Tst3JXORJwO";
  // ===========================================

  const API_URL = `https://api.jsonbin.io/v3/b/${DIET_BIN_ID}`;
  let dietData = {}; // ë‚ ì§œë³„ ë°ì´í„°ë¥¼ ì €ì¥í•  ê°ì²´ { "2023-12-15": { ... } }
  let currentMonday = getMonday(new Date());

  const dayListEl = document.getElementById('dayList');
  const weekRangeEl = document.getElementById('weekRange');
  const loading = document.getElementById('loading');

  function init() {
    loadData();
  }

  function showMsg(txt) { loading.textContent = txt; }

  // 1. ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
  async function loadData() {
    showMsg("Loading...");
    try {
      const res = await fetch(API_URL + '/latest', {
        headers: { 'X-Master-Key': API_KEY }
      });
      const data = await res.json();
      
      // diet_logs í‚¤ê°€ ìˆìœ¼ë©´ ì“°ê³ , ì—†ìœ¼ë©´ ë¹ˆ ê°ì²´
      if (data.record && data.record.diet_logs) {
        dietData = data.record.diet_logs;
      } else {
        dietData = {};
      }
      
      renderWeek();
      showMsg("");
    } catch (e) {
      console.error(e);
      showMsg("Error loading.");
    }
  }

  // 2. ë°ì´í„° ì €ì¥í•˜ê¸°
  async function saveData() {
    showMsg("Saving...");
    try {
      await fetch(API_URL, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json', 'X-Master-Key': API_KEY },
        body: JSON.stringify({ diet_logs: dietData }),
      });
      showMsg("Saved!");
      setTimeout(() => showMsg(""), 1000);
    } catch (e) {
      console.error(e);
      showMsg("Save Failed");
    }
  }

  // 3. ì´ë²ˆì£¼ ë Œë”ë§
  function renderWeek() {
    dayListEl.innerHTML = '';
    
    // ì£¼ê°„ ë‚ ì§œ ê³„ì‚°
    const start = new Date(currentMonday);
    const end = new Date(currentMonday);
    end.setDate(end.getDate() + 6);

    // ë‚ ì§œ í‘œì‹œ (12.15 - 12.21)
    weekRangeEl.textContent = `${fmtDateShort(start)} - ${fmtDateShort(end)}`;

    // ì›”~ì¼ ìƒì„±
    for (let i = 0; i < 7; i++) {
      const d = new Date(currentMonday);
      d.setDate(d.getDate() + i);
      const dateKey = d.toISOString().split('T')[0]; // "2025-12-17"
      const dayName = ['SUN', 'MON', 'TUE', 'WED', 'THU', 'FRI', 'SAT'][d.getDay()];
      const isToday = (dateKey === new Date().toISOString().split('T')[0]);

      // ë°ì´í„° ê°€ì ¸ì˜¤ê¸° (ì—†ìœ¼ë©´ ê¸°ë³¸ê°’)
      const dayData = dietData[dateKey] || {
        breakfast: '', lunch: '', dinner: '',
        skip_b: false, skip_l: false, skip_d: false,
        habit_pill: false, habit_water: false
      };

      const div = document.createElement('div');
      div.className = `day-item ${isToday ? 'today active' : ''}`; // ì˜¤ëŠ˜ì€ ê¸°ë³¸ í¼ì¹¨
      
      div.innerHTML = `
        <div class="day-header" onclick="toggleDay(this)">
          <div class="day-title">${dayName} <span style="font-weight:400; color:#90A4AE; margin-left:5px;">${d.getDate()}</span></div>
          <div class="day-summary">
            ${dayData.habit_pill ? 'ğŸ’Š' : ''}
            ${dayData.habit_water ? 'ğŸ’§' : ''}
            ${(!dayData.habit_pill && !dayData.habit_water) ? 'No Habits' : ''}
          </div>
        </div>
        <div class="day-content">
          <div class="habit-section">
            <label class="habit-check">
              <input type="checkbox" onchange="updateHabit('${dateKey}', 'pill', this)" ${dayData.habit_pill ? 'checked' : ''}>
              <div class="habit-icon">ğŸ’Š</div> ìœ ì‚°ê· 
            </label>
            <div style="width:1px; background:#ECEFF1;"></div>
            <label class="habit-check">
              <input type="checkbox" onchange="updateHabit('${dateKey}', 'water', this)" ${dayData.habit_water ? 'checked' : ''}>
              <div class="habit-icon">ğŸ’§</div> ë¬¼ 1.5L
            </label>
          </div>

          <div class="meal-row">
            <div class="meal-label">
              <span>BREAKFAST</span>
              <label class="skip-label">
                <input type="checkbox" onchange="toggleSkip('${dateKey}', 'b', this)" ${dayData.skip_b ? 'checked' : ''}> SKIP
              </label>
            </div>
            <input type="text" class="meal-input ${dayData.skip_b ? 'skipped' : ''}" 
                   id="in_${dateKey}_b" value="${dayData.skip_b ? 'SKIPPED' : dayData.breakfast}" 
                   placeholder="ì•„ì¹¨ ì‹ë‹¨">
          </div>

          <div class="meal-row">
            <div class="meal-label">
              <span>LUNCH</span>
              <label class="skip-label">
                <input type="checkbox" onchange="toggleSkip('${dateKey}', 'l', this)" ${dayData.skip_l ? 'checked' : ''}> SKIP
              </label>
            </div>
            <input type="text" class="meal-input ${dayData.skip_l ? 'skipped' : ''}" 
                   id="in_${dateKey}_l" value="${dayData.skip_l ? 'SKIPPED' : dayData.lunch}" 
                   placeholder="ì ì‹¬ ì‹ë‹¨">
          </div>

          <div class="meal-row">
            <div class="meal-label">
              <span>DINNER</span>
              <label class="skip-label">
                <input type="checkbox" onchange="toggleSkip('${dateKey}', 'd', this)" ${dayData.skip_d ? 'checked' : ''}> SKIP
              </label>
            </div>
            <input type="text" class="meal-input ${dayData.skip_d ? 'skipped' : ''}" 
                   id="in_${dateKey}_d" value="${dayData.skip_d ? 'SKIPPED' : dayData.dinner}" 
                   placeholder="ì €ë… ì‹ë‹¨">
          </div>

          <button class="save-btn" onclick="saveDay('${dateKey}')">SAVE LOG</button>
        </div>
      `;
      dayListEl.appendChild(div);
    }
  }

  // 4. ê¸°ëŠ¥ í•¨ìˆ˜ë“¤
  
  // ì•„ì½”ë””ì–¸ í† ê¸€
  window.toggleDay = function(header) {
    header.parentElement.classList.toggle('active');
  }

  // ë‚ ì§œ ì´ë™
  window.changeWeek = function(offset) {
    currentMonday.setDate(currentMonday.getDate() + offset);
    renderWeek();
  }

  // ì‹ë‹¨ ì €ì¥
  window.saveDay = function(dateKey) {
    if (!dietData[dateKey]) dietData[dateKey] = {};
    
    // ì‹ë‹¨ í…ìŠ¤íŠ¸ ì €ì¥
    const b_in = document.getElementById(`in_${dateKey}_b`);
    const l_in = document.getElementById(`in_${dateKey}_l`);
    const d_in = document.getElementById(`in_${dateKey}_d`);

    // SKIP ìƒíƒœë©´ í…ìŠ¤íŠ¸ëŠ” ì €ì¥ ì•ˆ í•˜ê±°ë‚˜ SKIPìœ¼ë¡œ ì²˜ë¦¬
    if(!dietData[dateKey].skip_b) dietData[dateKey].breakfast = b_in.value;
    if(!dietData[dateKey].skip_l) dietData[dateKey].lunch = l_in.value;
    if(!dietData[dateKey].skip_d) dietData[dateKey].dinner = d_in.value;

    saveData();
  }

  // SKIP í† ê¸€
  window.toggleSkip = function(dateKey, type, checkbox) {
    if (!dietData[dateKey]) dietData[dateKey] = {};
    
    const key = `skip_${type}`; // skip_b, skip_l...
    dietData[dateKey][key] = checkbox.checked;

    const input = document.getElementById(`in_${dateKey}_${type}`);
    if (checkbox.checked) {
      input.classList.add('skipped');
      input.value = "SKIPPED";
    } else {
      input.classList.remove('skipped');
      // ê¸°ì¡´ ê°’ì´ ìˆìœ¼ë©´ ë³µêµ¬, ì—†ìœ¼ë©´ ë¹ˆì¹¸
      const mealKey = (type === 'b') ? 'breakfast' : (type === 'l') ? 'lunch' : 'dinner';
      input.value = dietData[dateKey][mealKey] || "";
    }
  }

  // ìŠµê´€ ì²´í¬ (+ì• ë‹ˆë©”ì´ì…˜)
  window.updateHabit = function(dateKey, type, checkbox) {
    if (!dietData[dateKey]) dietData[dateKey] = {};
    
    const key = `habit_${type}`;
    dietData[dateKey][key] = checkbox.checked;

    // ì¶•í•˜ ì• ë‹ˆë©”ì´ì…˜
    if (checkbox.checked) {
      triggerConfetti(checkbox.nextElementSibling); // ì•„ì´ì½˜ ìœ„ì¹˜ì—ì„œ í„°ì§
    }
    
    saveData(); // ìŠµê´€ì€ ë°”ë¡œ ì €ì¥
  }

  // í­ì£½ íš¨ê³¼
  function triggerConfetti(element) {
    const rect = element.getBoundingClientRect();
    const colors = ['#FFD54F', '#4FC3F7', '#81C784', '#F06292'];
    
    for (let i = 0; i < 15; i++) {
      const conf = document.createElement('div');
      conf.className = 'confetti';
      conf.style.left = rect.left + 'px';
      conf.style.top = rect.top + 'px';
      conf.style.background = colors[Math.floor(Math.random() * colors.length)];
      
      // ëœë¤ ë°©í–¥ìœ¼ë¡œ í¼ì§
      const tx = (Math.random() - 0.5) * 100 + 'px';
      const ty = (Math.random() - 1) * 100 + 'px';
      conf.style.setProperty('--tx', tx);
      conf.style.setProperty('--ty', ty);
      
      document.body.appendChild(conf);
      setTimeout(() => conf.remove(), 600);
    }
  }

  // ìœ í‹¸: ì´ë²ˆì£¼ ì›”ìš”ì¼ êµ¬í•˜ê¸°
  function getMonday(d) {
    d = new Date(d);
    const day = d.getDay();
    const diff = d.getDate() - day + (day === 0 ? -6 : 1);
    return new Date(d.setDate(diff));
  }
  
  // ìœ í‹¸: ë‚ ì§œ í¬ë§· (12.15)
  function fmtDateShort(d) {
    return `${d.getMonth()+1}.${d.getDate()}`;
  }

  init();
</script>
</body>
</html>