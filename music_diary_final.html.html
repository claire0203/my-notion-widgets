<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MUSIC DIARY</title>
<style>
  /* --- Apple UI & Pastel Blue Theme --- */
  :root {
    --bg-gradient: linear-gradient(135deg, #F0F8FF 0%, #E3F2FD 100%); /* ì€ì€í•œ íŒŒìŠ¤í…” ë¸”ë£¨ ë°°ê²½ */
    --card-bg: rgba(255, 255, 255, 0.75); /* ë°˜íˆ¬ëª… ìœ ë¦¬ ëŠë‚Œ */
    --card-border: rgba(255, 255, 255, 0.8);
    --text-main: #1C1C1E; /* iOS Black */
    --text-sub: #8E8E93; /* iOS Gray */
    --accent-color: #5FA8D3; /* ì„¸ë ¨ëœ íŒŒìŠ¤í…” ë¸”ë£¨ */
    --accent-hover: #4A90E2;
    --danger-color: #FF6B6B; /* íŒŒìŠ¤í…” ë ˆë“œ */
    --shadow: 0 12px 40px rgba(0, 0, 0, 0.08); /* ë¶€ë“œëŸ¬ìš´ ê·¸ë¦¼ì */
    --radius: 24px;
    --font-stack: -apple-system, BlinkMacSystemFont, "Pretendard", "xF095", sans-serif;
  }

  body {
    background: var(--bg-gradient);
    display: flex;
    justify-content: center;
    align-items: flex-start; 
    min-height: 100vh;
    margin: 0;
    padding: 40px 20px;
    font-family: var(--font-stack);
    color: var(--text-main);
    box-sizing: border-box;
  }

  /* ë©”ì¸ ì¹´ë“œ (Glassmorphism) */
  .diary-card {
    background: var(--card-bg);
    backdrop-filter: blur(20px); /* iOS ë¸”ëŸ¬ íš¨ê³¼ */
    -webkit-backdrop-filter: blur(20px);
    border: 1px solid var(--card-border);
    width: 100%;
    max-width: 480px;
    padding: 32px;
    border-radius: var(--radius);
    box-shadow: var(--shadow);
    display: flex;
    flex-direction: column;
    min-height: 600px;
  }

  /* íƒ€ì´í‹€ */
  h1 {
    text-align: center;
    font-size: 24px;
    font-weight: 700;
    letter-spacing: 1px;
    margin: 0 0 30px 0;
    color: var(--text-main);
  }

  /* --- ì…ë ¥ í¼ ì˜ì—­ --- */
  .input-area {
    display: flex;
    flex-direction: column;
    gap: 12px;
    margin-bottom: 30px;
  }

  /* iOS ìŠ¤íƒ€ì¼ Input */
  input, textarea {
    width: 100%;
    padding: 14px 16px;
    border: none;
    border-radius: 14px;
    background: #F2F2F7; /* iOS System Gray 6 */
    font-size: 15px;
    font-family: var(--font-stack);
    color: var(--text-main);
    box-sizing: border-box;
    transition: all 0.2s ease;
    outline: none;
  }

  input:focus, textarea:focus {
    background: #FFFFFF;
    box-shadow: 0 0 0 2px var(--accent-color);
  }

  .embed-input {
    font-family: monospace; /* ì½”ë“œëŠ” ê³ ì •í­ ê¸€ê¼´ */
    font-size: 12px;
    color: #555;
  }

  /* ë²„íŠ¼ ê·¸ë£¹ */
  .btn-group {
    display: flex;
    gap: 10px;
  }

  button {
    padding: 14px;
    border: none;
    border-radius: 14px;
    font-size: 16px;
    font-weight: 600;
    cursor: pointer;
    transition: transform 0.1s, background-color 0.2s;
    width: 100%;
  }

  #saveBtn {
    background: var(--accent-color);
    color: white;
    flex: 2;
  }
  #saveBtn:hover { background: var(--accent-hover); }
  
  #cancelBtn {
    background: #E5E5EA;
    color: var(--text-sub);
    flex: 1;
    display: none; /* ê¸°ë³¸ ìˆ¨ê¹€ */
  }
  #cancelBtn:hover { background: #D1D1D6; }

  /* --- ë¦¬ìŠ¤íŠ¸ ì˜ì—­ --- */
  #diaryList {
    list-style: none;
    padding: 0;
    margin: 0;
    flex-grow: 1;
  }

  .diary-entry {
    background: #FFFFFF;
    padding: 20px;
    border-radius: 18px;
    margin-bottom: 20px;
    box-shadow: 0 4px 12px rgba(0,0,0,0.03);
    animation: fadeIn 0.4s ease;
    position: relative;
    border: 1px solid rgba(0,0,0,0.03);
  }

  .entry-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 12px;
  }

  .entry-date {
    font-size: 13px;
    font-weight: 600;
    color: var(--accent-color);
    background: #F0F8FF;
    padding: 4px 10px;
    border-radius: 20px;
  }

  .action-buttons {
    display: flex;
    gap: 8px;
  }

  .icon-btn {
    background: none;
    border: none;
    cursor: pointer;
    font-size: 13px;
    padding: 4px 8px;
    border-radius: 8px;
    font-weight: 500;
    transition: background 0.2s;
  }

  .edit-btn { color: var(--accent-color); background: #EBF5FF; }
  .edit-btn:hover { background: #D6EAF8; }
  
  .delete-btn { color: var(--danger-color); background: #FFF0F0; }
  .delete-btn:hover { background: #FFE0E0; }

  .entry-note {
    font-size: 15px;
    line-height: 1.6;
    color: var(--text-main);
    margin-bottom: 15px;
    white-space: pre-wrap; /* ì¤„ë°”ê¿ˆ ìœ ì§€ */
  }

  /* í”Œë ˆì´ì–´ ë˜í¼ */
  .entry-player {
    width: 100%;
    border-radius: 14px;
    overflow: hidden;
    background: #F9F9F9;
    /* ì• í”Œë®¤ì§ ì„ë² ë“œ ì‚¬ì´ì¦ˆ ì¡°ì ˆ */
  }
  
  .entry-player iframe {
    width: 100% !important;
    border: none !important;
    display: block;
  }

  /* í˜ì´ì§€ë„¤ì´ì…˜ */
  .pagination-controls {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 20px;
    margin-top: 20px;
  }

  .page-btn {
    width: 40px;
    height: 40px;
    border-radius: 50%;
    padding: 0;
    background: white;
    color: var(--accent-color);
    box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 18px;
  }
  .page-btn:disabled { color: #ccc; cursor: default; box-shadow: none; background: #f9f9f9; }
  
  .page-info { font-size: 14px; font-weight: 600; color: var(--text-sub); }

  /* ë¡œë”© í‘œì‹œ */
  #loadingIndicator {
    text-align: center;
    color: var(--text-sub);
    font-size: 13px;
    margin-bottom: 10px;
    height: 20px; 
    opacity: 0;
    transition: opacity 0.3s;
  }
  #loadingIndicator.show { opacity: 1; }

  @keyframes fadeIn {
    from { opacity: 0; transform: translateY(10px); }
    to { opacity: 1; transform: translateY(0); }
  }

</style>
</head>
<body>

<div class="diary-card">
  <h1>MUSIC DIARY</h1>

  <div id="loadingIndicator">Loading...</div>

  <div class="input-area">
    <input type="date" id="dateInput">
    <input type="text" id="noteInput" placeholder="ì˜¤ëŠ˜ì˜ ì½”ë©˜íŠ¸ (Comment)">
    <input type="text" id="embedInput" class="embed-input" placeholder='ì• í”Œë®¤ì§ Embed Code (<iframe...)'>
    
    <div class="btn-group">
      <button id="cancelBtn">ì·¨ì†Œ</button>
      <button id="saveBtn">ê¸°ë¡í•˜ê¸°</button>
    </div>
  </div>

  <ul id="diaryList"></ul>

  <div class="pagination-controls">
    <button id="prevBtn" class="page-btn">â€¹</button>
    <span id="pageInfo" class="page-info">1 / 1</span>
    <button id="nextBtn" class="page-btn">â€º</button>
  </div>
</div>

<script>
  // =======================================================
  // [í•„ìˆ˜] API ì •ë³´ ì…ë ¥ (ê¸°ì¡´ ì •ë³´ë¥¼ ì—¬ê¸°ì— ë‹¤ì‹œ ë„£ì–´ì£¼ì„¸ìš”)
  const DIARY_BIN_ID = "693edb14ae596e708f998cfa"; 
  const API_KEY = "$2a$10$7/urvzV65WS3eRC9dhD4Pe5dDs/W2TYnytNLMFjLA3Tst3JXORJwO";
  // =======================================================

  const API_URL = `https://api.jsonbin.io/v3/b/${DIARY_BIN_ID}`;
  
  let diaryData = [];
  let isEditing = false; // ìˆ˜ì • ëª¨ë“œì¸ì§€ í™•ì¸
  let editId = null;     // ìˆ˜ì • ì¤‘ì¸ í•­ëª©ì˜ ID

  // í˜ì´ì§€ë„¤ì´ì…˜
  let currentPage = 1;
  const itemsPerPage = 3;

  // DOM Elements
  const loadingIndicator = document.getElementById('loadingIndicator');
  const dateInput = document.getElementById('dateInput');
  const noteInput = document.getElementById('noteInput');
  const embedInput = document.getElementById('embedInput');
  const saveBtn = document.getElementById('saveBtn');
  const cancelBtn = document.getElementById('cancelBtn');
  const diaryList = document.getElementById('diaryList');
  const prevBtn = document.getElementById('prevBtn');
  const nextBtn = document.getElementById('nextBtn');
  const pageInfo = document.getElementById('pageInfo');

  function init() {
    dateInput.valueAsDate = new Date(); // ì˜¤ëŠ˜ ë‚ ì§œ ê¸°ë³¸
    loadData();
    
    saveBtn.addEventListener('click', handleSave);
    cancelBtn.addEventListener('click', resetForm);
    prevBtn.addEventListener('click', () => changePage(-1));
    nextBtn.addEventListener('click', () => changePage(1));
  }

  function showMsg(txt, show=true) {
    loadingIndicator.textContent = txt;
    loadingIndicator.classList.toggle('show', show);
  }

  // --- Read ---
  async function loadData() {
    showMsg("Loading...");
    try {
      const response = await fetch(API_URL + '/latest', {
        method: 'GET',
        headers: { 'X-Master-Key': API_KEY }
      });
      const data = await response.json();
      diaryData = Array.isArray(data.record) ? data.record : [];
      
      // í˜¹ì‹œ ë°ì´í„° í˜•ì‹ì´ ë‹¤ë¥´ë©´ ë¹ˆ ë°°ì—´ ì²˜ë¦¬
      if(!Array.isArray(diaryData)) diaryData = [];

      currentPage = 1;
      renderDiary();
      showMsg("", false);
    } catch (e) {
      console.error(e);
      showMsg("Failed to load data.");
    }
  }

  // --- Create & Update ---
  async function handleSave() {
    const date = dateInput.value;
    const note = noteInput.value.trim();
    const embedCode = embedInput.value.trim();

    // ìœ íš¨ì„± ê²€ì‚¬
    if (!embedCode.startsWith('<iframe')) {
      alert("ì˜¬ë°”ë¥¸ ì• í”Œë®¤ì§ 'ì„ë² ë“œ ì½”ë“œ(iframe)'ë¥¼ ë„£ì–´ì£¼ì„¸ìš”!");
      return;
    }

    showMsg("Saving...");

    if (isEditing) {
      // [ìˆ˜ì •] ê¸°ì¡´ ë°ì´í„° ì°¾ì•„ì„œ ì—…ë°ì´íŠ¸
      const index = diaryData.findIndex(item => item.id === editId);
      if (index !== -1) {
        diaryData[index] = { ...diaryData[index], date, note, embed: embedCode };
      }
    } else {
      // [ì‹ ê·œ] ìƒˆ ë°ì´í„° ì¶”ê°€
      const newEntry = {
        id: Date.now(), // ê³ ìœ  ID ìƒì„±
        date: date,
        note: note,
        embed: embedCode
      };
      diaryData.unshift(newEntry); // ë§¨ ì•ì— ì¶”ê°€
    }

    try {
      await fetch(API_URL, {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json', 'X-Master-Key': API_KEY },
        body: JSON.stringify(diaryData),
      });
      
      resetForm(); // ì…ë ¥ì°½ ì´ˆê¸°í™” ë° ëª¨ë“œ í•´ì œ
      renderDiary();
      showMsg("Saved!", true);
      setTimeout(() => showMsg("", false), 2000);
    } catch (e) {
      console.error(e);
      showMsg("Error saving data.");
    }
  }

  // --- Edit Mode Start ---
  window.startEdit = function(id) {
    const item = diaryData.find(e => e.id === id);
    if (!item) return;

    // ì…ë ¥ì°½ì— ê°’ ì±„ìš°ê¸°
    dateInput.value = item.date;
    noteInput.value = item.note;
    embedInput.value = item.embed;

    // ìˆ˜ì • ëª¨ë“œ í™œì„±í™”
    isEditing = true;
    editId = id;

    // UI ë³€ê²½
    saveBtn.textContent = "ìˆ˜ì • ì™„ë£Œ (Update)";
    saveBtn.style.background = "#4CD964"; // ë…¹ìƒ‰ ê³„ì—´ (iOS Success color ëŠë‚Œ)
    cancelBtn.style.display = "block"; // ì·¨ì†Œ ë²„íŠ¼ ë³´ì´ê¸°
    
    window.scrollTo({ top: 0, behavior: 'smooth' }); // ë§¨ ìœ„ë¡œ ì´ë™
  }

  // --- Delete ---
  window.deleteEntry = function(id) {
    if (!confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
    
    diaryData = diaryData.filter(e => e.id !== id);
    
    // ì‚­ì œ í›„ ë°”ë¡œ ì €ì¥
    showMsg("Deleting...");
    fetch(API_URL, {
      method: 'PUT',
      headers: { 'Content-Type': 'application/json', 'X-Master-Key': API_KEY },
      body: JSON.stringify(diaryData),
    }).then(() => {
      renderDiary();
      showMsg("", false);
      
      // ë§Œì•½ ìˆ˜ì • ì¤‘ì´ë˜ í•­ëª©ì„ ì‚­ì œí–ˆë‹¤ë©´ í¼ ì´ˆê¸°í™”
      if (isEditing && editId === id) resetForm();
    });
  }

  // --- Reset Form ---
  function resetForm() {
    dateInput.valueAsDate = new Date();
    noteInput.value = '';
    embedInput.value = '';
    
    isEditing = false;
    editId = null;

    saveBtn.textContent = "ê¸°ë¡í•˜ê¸°";
    saveBtn.style.background = ""; // ì›ë˜ ìƒ‰ìœ¼ë¡œ ë³µê·€
    cancelBtn.style.display = "none";
  }

  // --- Render ---
  function renderDiary() {
    diaryList.innerHTML = '';
    
    if (diaryData.length === 0) {
      diaryList.innerHTML = '<li style="text-align:center; color:#999; padding:40px;">No music records yet. ğŸ§</li>';
      pageInfo.textContent = "0 / 0";
      prevBtn.disabled = true;
      nextBtn.disabled = true;
      return;
    }

    // Pagination Logic
    const totalPages = Math.ceil(diaryData.length / itemsPerPage);
    if (currentPage > totalPages) currentPage = totalPages;
    if (currentPage < 1) currentPage = 1;

    const start = (currentPage - 1) * itemsPerPage;
    const end = start + itemsPerPage;
    const pageData = diaryData.slice(start, end);

    pageData.forEach((entry) => {
      const li = document.createElement('li');
      li.className = 'diary-entry';
      
      const dateObj = new Date(entry.date);
      const dateStr = `${dateObj.getFullYear()}. ${dateObj.getMonth()+1}. ${dateObj.getDate()}.`;

      li.innerHTML = `
        <div class="entry-header">
          <span class="entry-date">${dateStr}</span>
          <div class="action-buttons">
            <button class="icon-btn edit-btn" onclick="startEdit(${entry.id})">Edit</button>
            <button class="icon-btn delete-btn" onclick="deleteEntry(${entry.id})">Delete</button>
          </div>
        </div>
        ${entry.note ? `<div class="entry-note">${entry.note}</div>` : ''}
        <div class="entry-player">
          ${entry.embed} 
        </div>
      `;
      diaryList.appendChild(li);
    });

    // Control Updates
    pageInfo.textContent = `${currentPage} / ${totalPages}`;
    prevBtn.disabled = currentPage === 1;
    nextBtn.disabled = currentPage === totalPages;
  }

  function changePage(step) {
    currentPage += step;
    renderDiary();
  }

  // Start
  init();
</script>
</body>
</html>